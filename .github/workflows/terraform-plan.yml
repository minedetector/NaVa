name: Terraform Plan

on:
  pull_request:
    branches: [main]
    paths:
      - 'pre-requisites/**'
      - 'beginner-lab/**'
      - 'serverless-lab/**'
      - '.github/workflows/terraform-*.yml'
      - '.github/workflows/detect-changes.yml'

permissions:
  contents: read
  pull-requests: write
  id-token: write  # Required for OIDC

jobs:
  detect-changes:
    uses: ./.github/workflows/detect-changes.yml
    with:
      base-ref: ${{ github.base_ref }}

  terraform-plan:
    name: Plan (${{ matrix.directory }})
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true'

    strategy:
      fail-fast: false
      # Run Terraform plan for each changed directory
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}

    defaults:
      run:
        working-directory: ./${{ matrix.directory }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.0
          terraform_wrapper: false  # Required for proper output capture

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::187833180667:role/github_workflow
          role-session-name: github_workflow_plan_${{ matrix.directory }}
          aws-region: eu-north-1

      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Init
        id: init
        run: terraform init

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color

      - name: Terraform Plan
        id: plan
        run: terraform plan -no-color -input=false

      - name: Post Plan to PR Comment
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        env:
          PLAN: "${{ steps.plan.outputs.stdout }}\n${{ steps.plan.outputs.stderr }}"
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const directory = '${{ matrix.directory }}';
            const fmtOutcome = '${{ steps.fmt.outcome }}';
            const initOutcome = '${{ steps.init.outcome }}';
            const validateOutcome = '${{ steps.validate.outcome }}';
            const planOutcome = '${{ steps.plan.outcome }}';
            const planOutput = process.env.PLAN;

            // Parse plan output for summary
            let summary = 'No changes detected';
            let planDetails = planOutput;

            // Extract plan summary
            const planMatch = planOutput.match(/Plan: (\d+) to add, (\d+) to change, (\d+) to destroy/);
            if (planMatch) {
              const [, add, change, destroy] = planMatch;
              summary = `**${add}** to add, **${change}** to change, **${destroy}** to destroy`;
            } else if (planOutput.includes('No changes')) {
              summary = '**No changes.** Infrastructure is up-to-date.';
            } else if (planOutput.includes('Error')) {
              summary = '**Error occurred during planning.**';
            }

            // Truncate plan output if too long (GitHub comment limit)
            const maxLength = 65000;
            if (planDetails.length > maxLength) {
              planDetails = planDetails.substring(0, maxLength) + '\n\n... (output truncated)';
            }

            // Status emoji helper
            const emoji = (outcome) => {
              switch(outcome) {
                case 'success': return 'âœ…';
                case 'failure': return 'âŒ';
                case 'skipped': return 'â­ï¸';
                default: return 'â“';
              }
            };

            // Build comment body
            const output = `## ğŸ“‹ Terraform Plan: \`${directory}\`

            | Check | Status |
            |-------|--------|
            | Format | ${emoji(fmtOutcome)} \`${fmtOutcome}\` |
            | Init | ${emoji(initOutcome)} \`${initOutcome}\` |
            | Validate | ${emoji(validateOutcome)} \`${validateOutcome}\` |
            | Plan | ${emoji(planOutcome)} \`${planOutcome}\` |

            ### ğŸ“Š Summary
            ${summary}

            <details>
            <summary>ğŸ“„ Show Full Plan Output</summary>

            \`\`\`terraform
            ${planDetails}
            \`\`\`

            </details>

            ---
            **Workflow:** \`${{ github.workflow }}\` | **Directory:** \`${directory}\` | **Event:** \`${{ github.event_name }}\``;

            // Find existing comment for this directory
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes(`Terraform Plan: \`${directory}\``)
            );

            // Update existing comment or create new one
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: output
              });
              console.log('Updated existing comment');
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: output
              });
              console.log('Created new comment');
            }

      - name: Terraform Plan Status
        if: steps.plan.outcome == 'failure'
        run: |
          echo "::error::Terraform plan failed for ${{ matrix.directory }}"
          exit 1

  plan-summary:
    name: Plan Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, terraform-plan]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "## ğŸ“‹ Terraform Plan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.detect-changes.outputs.has-changes }}" == "false" ]; then
            echo "â„¹ï¸ **No Terraform changes detected**" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.terraform-plan.result }}" == "success" ]; then
            echo "âœ… **All plans succeeded**" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.terraform-plan.result }}" == "failure" ]; then
            echo "âŒ **One or more plans failed**" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âš ï¸ **Plan status unknown**" >> $GITHUB_STEP_SUMMARY
          fi
