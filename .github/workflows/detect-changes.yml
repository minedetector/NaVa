name: Detect Terraform Changes

on:
  workflow_call:
    inputs:
      base-ref:
        description: 'Base branch to compare against'
        required: false
        type: string
        default: 'main'
      manual-directory:
        description: 'Manually specified directory (or "all")'
        required: false
        type: string
        default: ''
    outputs:
      matrix:
        description: 'JSON matrix of changed directories'
        value: ${{ jobs.detect.outputs.matrix }}
      has-changes:
        description: 'Whether any Terraform directories changed'
        value: ${{ jobs.detect.outputs.has-changes }}

jobs:
  detect:
    name: Detect Changed Directories
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has-changes: ${{ steps.set-matrix.outputs.has-changes }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect Changed Terraform Directories
        id: set-matrix
        run: |
          # Handle manual directory input
          if [ -n "${{ inputs.manual-directory }}" ]; then
            MANUAL_DIR="${{ inputs.manual-directory }}"

            if [ "$MANUAL_DIR" == "all" ]; then
              CHANGED_DIRS=("pre-requisites" "beginner-lab" "serverless-lab")
            else
              CHANGED_DIRS=("$MANUAL_DIR")
            fi

            echo "Manual trigger: ${CHANGED_DIRS[*]}"
            echo "has-changes=true" >> $GITHUB_OUTPUT
            MATRIX_JSON=$(printf '%s\n' "${CHANGED_DIRS[@]}" | jq -R . | jq -s -c '{directory: .}')
            echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Auto-detect changes based on event type
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # For PRs, compare against base branch
            BASE_SHA=$(git merge-base origin/${{ inputs.base-ref }} HEAD)
            CHANGED_FILES=$(git diff --name-only $BASE_SHA HEAD)
          else
            # For push events, compare with previous commit
            if [ "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ]; then
              # Initial commit or force push
              CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r ${{ github.sha }})
            else
              CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
            fi
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Initialize array for changed directories
          CHANGED_DIRS=()

          # Check each Terraform directory
          if echo "$CHANGED_FILES" | grep -q '^infrastructure/pre-requisites/'; then
            CHANGED_DIRS+=("infrastructure/pre-requisites")
          fi

          if echo "$CHANGED_FILES" | grep -q '^infrastructure/beginner-lab/'; then
            CHANGED_DIRS+=("infrastructure/beginner-lab")
          fi

          if echo "$CHANGED_FILES" | grep -q '^infrastructure/serverless-lab/'; then
            CHANGED_DIRS+=("infrastructure/serverless-lab")
          fi

          # Create JSON matrix
          if [ ${#CHANGED_DIRS[@]} -eq 0 ]; then
            echo "No Terraform directories changed"
            echo "has-changes=false" >> $GITHUB_OUTPUT
            echo "matrix={\"directory\":[]}" >> $GITHUB_OUTPUT
          else
            echo "Changed directories: ${CHANGED_DIRS[*]}"
            echo "has-changes=true" >> $GITHUB_OUTPUT

            # Convert array to JSON
            MATRIX_JSON=$(printf '%s\n' "${CHANGED_DIRS[@]}" | jq -R . | jq -s -c '{directory: .}')
            echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
          fi
